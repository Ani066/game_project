<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maze Runner v3.1 (Runnable)</title>
<style>
:root{--bg:#071024;--card:#0b1220;--muted:#9aa4b2;--accent:#22c55e}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,var(--bg),#0b1220);color:#e6eef6;min-height:100vh}
.app{max-width:980px;margin:28px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center}
h1{margin:0}
.card{background:var(--card);padding:12px;border-radius:10px;margin-top:12px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.button{background:#153242;border:none;padding:10px 14px;border-radius:8px;color:#dff5e1;cursor:pointer}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
.banner{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;background:#111827;padding:8px 12px;border-radius:8px;color:#9aa4b2;border:1px solid rgba(255,255,255,0.03);z-index:9999}
.screen{display:none}
.screen.active{display:block}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:12px}
.levelCard{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center;cursor:pointer}
.locked{opacity:0.4;cursor:not-allowed}
.canvas-wrap{display:flex;justify-content:center;margin-top:12px}
canvas{background:#071026;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);max-width:100%;height:auto}
.hud{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:8px}
.small{color:var(--muted);font-size:13px}
.modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:10000}
.modal .inner{background:var(--card);padding:16px;border-radius:10px;text-align:center}
.skin-item{display:inline-block;padding:8px;border-radius:8px;margin:6px;background:rgba(255,255,255,0.02);cursor:pointer}
.selected{outline:3px solid rgba(99,102,241,0.18)}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Maze Runner v3.1 (Runnable)</h1>
    <div class="small">Ad placeholder integrated</div>
  </div>

  <!-- Home Screen -->
  <div id="home" class="card screen active">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small">Unlocked: <span id="unlockedLabel">1</span></div>
        <div class="small">Best Score: <span id="bestLabel">0</span></div>
        <div class="small">Coins: <span id="coinsLabel">0</span></div>
      </div>
      <div class="controls">
        <button class="button" onclick="showScreen('levels')">Play</button>
        <button class="button ghost" onclick="openSkins()">Skins</button>
        <button class="button" onclick="watchHomeReward()">Watch Ad (10 coins)</button>
      </div>
    </div>
    <div class="card small" style="margin-top:12px">Controls: Arrow keys or on-screen buttons. Reach the green exit.</div>
  </div>

  <!-- Levels Screen -->
  <div id="levels" class="card screen">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Select Level</h2>
      <div class="controls"><button class="button ghost" onclick="showScreen('home')">Back</button></div>
    </div>
    <div id="levelsGrid" class="grid"></div>
  </div>

  <!-- Game Screen -->
  <div id="game" class="card screen">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">Level <span id="uiLevel">1</span></div>
      <div class="small">Lives: <span id="uiLives">3</span> ‚Ä¢ Time: <span id="uiTime">0s</span> ‚Ä¢ Score: <span id="uiScore">0</span></div>
      <div class="controls"><button class="button ghost" onclick="quitToHome()">Quit</button></div>
    </div>
    <div class="canvas-wrap"><canvas id="canvas" width="540" height="540"></canvas></div>
    <div class="controls" style="justify-content:center;margin-top:8px">
      <button class="button" onclick="move('up')">‚¨ÜÔ∏è</button>
      <button class="button" onclick="move('left')">‚¨ÖÔ∏è</button>
      <button class="button" onclick="move('down')">‚¨áÔ∏è</button>
      <button class="button" onclick="move('right')">‚û°Ô∏è</button>
    </div>
  </div>

  <!-- Banner Placeholder -->
  <div class="banner" id="banner">Ad Banner Placeholder</div>
</div>

<!-- Skins modal -->
<div id="skinsModal" class="modal"><div class="inner"><h3>Choose Runner</h3><div id="skinsList"></div><p><button class="button" onclick="closeSkins()">Close</button></p></div></div>

<!-- Ad modal -->
<div id="adModal" class="modal"><div class="inner"><h3 id="adTitle">Ad</h3><div style="font-size:20px;margin:10px">Ad playing... <span id="adTimer">5</span>s</div><p><button class="button" id="closeAdBtn" disabled>Close</button></p></div></div>

<script>
/* Runnable single-file Maze Runner v3.1
   - Home, Levels, Game in same file to avoid path issues
   - Ad placeholders: showInterstitialAd(), showRewardedAd(), banner visible
*/

// Storage keys
const STORAGE_UNLOCK = 'mr3_unlocked_v1';
const STORAGE_BEST = 'mr3_best_v1';
const STORAGE_COINS = 'mr3_coins_v1';
const STORAGE_SKIN = 'mr3_skin_v1';

// initial state
let unlocked = parseInt(localStorage.getItem(STORAGE_UNLOCK) || '1',10);
let best = parseInt(localStorage.getItem(STORAGE_BEST) || '0',10);
let coins = parseInt(localStorage.getItem(STORAGE_COINS) || '0',10);
let selectedSkin = localStorage.getItem(STORAGE_SKIN) || 'knight';

document.getElementById('unlockedLabel').textContent = unlocked;
document.getElementById('bestLabel').textContent = best;
document.getElementById('coinsLabel').textContent = coins;

// screens
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  if(name==='levels') buildLevelGrid();
  if(name==='home') updateHUD();
}

// skins
const SKINS = [
  {id:'knight', label:'Knight', price:0, emoji:'üõ°Ô∏è'},
  {id:'ninja', label:'Ninja', price:30, emoji:'ü•∑'},
  {id:'robot', label:'Robot', price:50, emoji:'ü§ñ'},
  {id:'fox', label:'Fox', price:80, emoji:'ü¶ä'}
];
function openSkins(){
  const box = document.getElementById('skinsList'); box.innerHTML='';
  SKINS.forEach(s=>{
    const el = document.createElement('div');
    el.className = 'skin-item' + (selectedSkin===s.id ? ' selected' : '');
    el.innerHTML = `<div style="font-size:28px">${s.emoji}</div><div>${s.label}</div><div class="small">${s.price>0?('Price: '+s.price+' coins'):'Free'}</div>`;
    el.onclick = ()=>{
      if(s.price>0 && !owned(s.id)){
        if(coins >= s.price){
          if(confirm('Spend '+s.price+' coins to buy '+s.label+'?')){
            coins -= s.price; localStorage.setItem(STORAGE_COINS, coins);
            localStorage.setItem(STORAGE_SKIN, s.id); selectedSkin = s.id; alert('Purchased!'); openSkins(); updateHUD();
          }
        } else { alert('Not enough coins. Watch rewarded ads to earn more.'); }
      } else {
        localStorage.setItem(STORAGE_SKIN, s.id); selectedSkin = s.id; alert('Selected ' + s.label); openSkins(); updateHUD();
      }
    };
    box.appendChild(el);
  });
  document.getElementById('skinsModal').style.display = 'flex';
}
function closeSkins(){ document.getElementById('skinsModal').style.display='none'; }
function owned(id){ if(id==='knight') return true; const price = SKINS.find(s=>s.id===id).price; const bought = localStorage.getItem('skin_bought_' + id); return bought==='1' || (localStorage.getItem(STORAGE_SKIN)===id); }

// coins and ads
function addCoins(n){ coins = parseInt(localStorage.getItem(STORAGE_COINS) || '0',10) + n; localStorage.setItem(STORAGE_COINS, coins); updateHUD(); }
function updateHUD(){ document.getElementById('coinsLabel').textContent = localStorage.getItem(STORAGE_COINS)||'0'; document.getElementById('bestLabel').textContent = localStorage.getItem(STORAGE_BEST)||'0'; document.getElementById('unlockedLabel').textContent = localStorage.getItem(STORAGE_UNLOCK)||'1'; }

function showBannerAd(){ document.getElementById('banner').style.display='block'; }
function hideBannerAd(){ document.getElementById('banner').style.display='none'; }

function showInterstitialAd(opts={onClose:()=>{}}){
  const modal = document.getElementById('adModal');
  document.getElementById('adTitle').textContent = 'Interstitial Ad (placeholder)';
  modal.style.display = 'flex';
  let t = 3; document.getElementById('adTimer').textContent = t; const iv = setInterval(()=>{ t--; document.getElementById('adTimer').textContent = t; if(t<=0){ clearInterval(iv); document.getElementById('closeAdBtn').disabled=false; document.getElementById('closeAdBtn').textContent='Close Ad'; } },1000);
  document.getElementById('closeAdBtn').disabled=true; document.getElementById('closeAdBtn').textContent='Close (wait)';
  document.getElementById('closeAdBtn').onclick = ()=>{ modal.style.display='none'; document.getElementById('closeAdBtn').disabled=true; document.getElementById('closeAdBtn').textContent='Close (wait)'; opts.onClose(); };
}

function showRewardedAd(opts={onComplete:()=>{}, onFail:()=>{}}){
  const modal = document.getElementById('adModal');
  document.getElementById('adTitle').textContent = 'Rewarded Ad (placeholder)';
  modal.style.display = 'flex';
  let t = 5; document.getElementById('adTimer').textContent = t; const iv = setInterval(()=>{ t--; document.getElementById('adTimer').textContent = t; if(t<=0){ clearInterval(iv); document.getElementById('closeAdBtn').disabled=false; document.getElementById('closeAdBtn').textContent='Claim Reward'; } },1000);
  document.getElementById('closeAdBtn').disabled=true; document.getElementById('closeAdBtn').textContent='Close (wait)';
  document.getElementById('closeAdBtn').onclick = ()=>{ modal.style.display='none'; document.getElementById('closeAdBtn').disabled=true; document.getElementById('closeAdBtn').textContent='Close (wait)'; opts.onComplete(); };
}

// Home rewarded button
function watchHomeReward(){ showRewardedAd({onComplete: ()=>{ addCoins(10); alert('You earned 10 coins!'); }}); }

// Level grid
function buildLevelGrid(){
  const grid = document.getElementById('levelsGrid'); grid.innerHTML='';
  const max = 20; const unlocked = parseInt(localStorage.getItem(STORAGE_UNLOCK) || '1',10);
  for(let i=1;i<=max;i++){
    const d = document.createElement('div'); d.className='levelCard' + (i>unlocked?' locked':'');
    d.textContent = 'Level ' + i + (i>unlocked?' üîí':'');
    d.onclick = ()=>{ if(i>unlocked){ alert('Locked. Unlock by clearing previous levels.'); return; } startLevel(i); };
    grid.appendChild(d);
  }
}

// Simple maze generator (odd-size)
function generateMaze(size){
  if(size%2===0) size++;
  const w = size, h = size;
  const maze = Array.from({length:h}, ()=> Array.from({length:w}, ()=>1));
  function carve(x,y){
    maze[y][x]=0;
    const dirs = [[0,-2],[2,0],[0,2],[-2,0]].sort(()=>Math.random()-0.5);
    for(const [dx,dy] of dirs){
      const nx=x+dx, ny=y+dy;
      if(nx>0 && ny>0 && nx<w-1 && ny<h-1 && maze[ny][nx]===1){
        maze[y+dy/2][x+dx/2]=0;
        carve(nx,ny);
      }
    }
  }
  carve(1,1); return maze;
}

// Gameplay state
let currentLevelIndex = 1;
let maze = null;
let cellSize = 0;
let player = {x:1,y:1,lives:3,score:0};
let gameInterval = null;
let timeCounter = 0;

// start level
function startLevel(index){
  currentLevelIndex = index;
  showScreen('game');
  document.getElementById('uiLevel').textContent = index;
  const size = 7 + Math.floor((index-1)/3)*2; maze = generateMaze(size); // ensure start and exit
  maze[1][1]=0; maze[size-2][size-2]=0;
  player = {x:1,y:1,lives: Math.max(3 - Math.floor(index/8),1), score:0};
  timeCounter = 0;
  cellSize = 540 / maze.length;
  draw();
  // start timer
  if(gameInterval) clearInterval(gameInterval);
  gameInterval = setInterval(()=>{ timeCounter++; document.getElementById('uiTime').textContent = timeCounter + 's'; },1000);
}

// draw maze and player
function draw(){
  const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const N = maze.length; const cell = canvas.width / N;
  for(let y=0;y<N;y++){
    for(let x=0;x<N;x++){
      if(maze[y][x]===1){ ctx.fillStyle='#0b1220'; ctx.fillRect(x*cell,y*cell,cell,cell); }
      else { ctx.fillStyle='#cbd5e1'; ctx.globalAlpha=0.06; ctx.fillRect(x*cell,y*cell,cell,cell); ctx.globalAlpha=1; }
    }
  }
  // exit
  ctx.fillStyle='#34d399'; ctx.fillRect((N-2)*cell,(N-2)*cell,cell,cell);
  // player
  ctx.beginPath(); ctx.fillStyle='#3b82f6'; ctx.arc(player.x*cell+cell/2, player.y*cell+cell/2, cell*0.3,0,Math.PI*2); ctx.fill();
  // HUD
  document.getElementById('uiLives').textContent = player.lives;
  document.getElementById('uiScore').textContent = player.score;
}

// movement
function canMove(nx,ny){
  if(!maze[ny] || typeof maze[ny][nx] === 'undefined') return false;
  if(maze[ny][nx] === 1) return false;
  return true;
}
function move(dir){
  let nx=player.x, ny=player.y;
  if(dir==='up') ny--; if(dir==='down') ny++; if(dir==='left') nx--; if(dir==='right') nx++;
  if(!canMove(nx,ny)) return;
  player.x=nx; player.y=ny; draw();
  // check exit
  if(player.x === maze.length-2 && player.y === maze.length-2){
    // award score and show interstitial, then unlock next
    player.score += Math.max(100 - timeCounter*2, 10);
    document.getElementById('bestLabel').textContent = Math.max(parseInt(localStorage.getItem(STORAGE_BEST)||'0',10), player.score);
    showInterstitialAd({onClose: ()=>{
      const unlockedNow = Math.max(parseInt(localStorage.getItem(STORAGE_UNLOCK)||'1',10), currentLevelIndex+1);
      localStorage.setItem(STORAGE_UNLOCK, unlockedNow);
      localStorage.setItem(STORAGE_BEST, Math.max(parseInt(localStorage.getItem(STORAGE_BEST)||'0',10), player.score));
      alert('Level cleared! Score: ' + player.score);
      showScreen('levels');
      if(gameInterval) clearInterval(gameInterval);
    }});
  }
}

// keyboard controls
document.addEventListener('keydown', (e)=>{
  if(document.getElementById('game').classList.contains('active')){
    if(e.key === 'ArrowUp') move('up');
    if(e.key === 'ArrowDown') move('down');
    if(e.key === 'ArrowLeft') move('left');
    if(e.key === 'ArrowRight') move('right');
  }
});

function quitToHome(){ if(gameInterval) clearInterval(gameInterval); showScreen('home'); }

// initial build
buildLevelGrid();
showBannerAd();
updateHUD();
</script>
</body>
</html>
